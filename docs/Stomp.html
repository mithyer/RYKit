<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STOMP æ¨¡å— - RYKit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/swift.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; position: relative; }
        .back-btn { position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.2); border: 2px solid white; color: white; padding: 10px 20px; border-radius: 25px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease; font-size: 14px; }
        .back-btn:hover { background: white; color: #667eea; transform: translateX(-5px); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .content { padding: 40px; }
        .section { margin-bottom: 50px; }
        .section-title { font-size: 2em; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #667eea; }
        .subsection { margin-bottom: 30px; }
        .subsection-title { font-size: 1.5em; color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .description { line-height: 1.8; color: #555; margin-bottom: 20px; font-size: 1.05em; }
        .feature-list { list-style: none; margin: 20px 0; }
        .feature-list li { padding: 12px 0 12px 35px; position: relative; color: #555; line-height: 1.6; }
        .feature-list li:before { content: "âœ“"; position: absolute; left: 10px; color: #667eea; font-weight: bold; font-size: 1.2em; }
        .code-block { margin: 20px 0; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .code-header { background: #21252b; color: #abb2bf; padding: 12px 20px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        .code-lang { font-weight: bold; color: #61afef; }
        pre { margin: 0 !important; border-radius: 0 !important; }
        pre code { display: block; padding: 20px !important; font-size: 14px; line-height: 1.6; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; }
        .api-table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border-radius: 10px; overflow: hidden; }
        .api-table th { background: #667eea; color: white; padding: 15px; text-align: left; font-weight: 600; }
        .api-table td { padding: 15px; border-bottom: 1px solid #eee; }
        .api-table tr:last-child td { border-bottom: none; }
        .api-table tr:nth-child(even) { background: #f8f9fa; }
        .highlight-box { background: #f0f7ff; border-left: 4px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .highlight-box-title { font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 1.1em; }
        .tag { display: inline-block; background: #667eea; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.85em; margin-right: 10px; margin-bottom: 10px; }
        @media (max-width: 768px) { .header h1 { font-size: 1.8em; } .content { padding: 20px; } .back-btn { position: static; margin-bottom: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn"><span>â†</span><span>è¿”å›ç´¢å¼•</span></a>
            <h1><span>ğŸ”Œ</span><span>WebSocket/STOMP æ¨¡å—</span></h1>
            <p>å®Œæ•´çš„ STOMP åè®®å®ç°ï¼Œç”¨äºå®æ—¶æ¶ˆæ¯é€šä¿¡</p>
        </div>

        <div class="content">
            <div class="section">
                <h2 class="section-title">æ¨¡å—æ¦‚è¿°</h2>
                <div class="description">
                    STOMP (Simple Text Oriented Messaging Protocol) æ¨¡å—æä¾›äº†å®Œæ•´çš„ WebSocket å®æ—¶æ¶ˆæ¯é€šä¿¡è§£å†³æ–¹æ¡ˆã€‚å®ƒåŸºäº STOMP åè®®ï¼Œæ”¯æŒè‡ªåŠ¨é‡è¿ã€è®¢é˜…ç®¡ç†ã€æ¶ˆæ¯èŠ‚æµç­‰é«˜çº§ç‰¹æ€§ï¼Œæ˜¯æ„å»ºå®æ—¶åº”ç”¨çš„ç†æƒ³é€‰æ‹©ã€‚
                </div>
                
                <div class="highlight-box">
                    <div class="highlight-box-title">ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿</div>
                    <ul class="feature-list" style="margin: 10px 0;">
                        <li>è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œç½‘ç»œæ–­å¼€åè‡ªåŠ¨æ¢å¤è¿æ¥</li>
                        <li>æ™ºèƒ½è®¢é˜…ç®¡ç†ï¼Œè‡ªåŠ¨é‡æ–°è®¢é˜…æ–­å¼€çš„é¢‘é“</li>
                        <li>æ”¯æŒæ¶ˆæ¯èŠ‚æµï¼Œé¿å…é¢‘ç¹æ›´æ–°å¯¼è‡´æ€§èƒ½é—®é¢˜</li>
                        <li>çº¿ç¨‹å®‰å…¨çš„æ¶ˆæ¯åˆ†å‘ç³»ç»Ÿ</li>
                        <li>ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†ï¼Œé‡Šæ”¾å³å–æ¶ˆè®¢é˜…</li>
                        <li>Combine æ¡†æ¶æ·±åº¦é›†æˆ</li>
                    </ul>
                </div>

                <div style="margin-top: 20px;">
                    <span class="tag">iOS 13.0+</span>
                    <span class="tag">macOS 10.15+</span>
                    <span class="tag">tvOS 13.0+</span>
                    <span class="tag">Swift 5.0+</span>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">å®‰è£…æ–¹å¼</h2>
                <div class="code-block">
                    <div class="code-header"><span class="code-lang">Ruby (Podfile)</span></div>
                    <pre><code class="language-ruby">pod 'RYKit/Stomp'</code></pre>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æ ¸å¿ƒæ¦‚å¿µ</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">ğŸ”¹ StompManager</h3>
                    <div class="description">
                        è®¢é˜…ç®¡ç†å™¨ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰çš„ WebSocket è¿æ¥å’Œè®¢é˜…ã€‚æ¯ä¸ªç”¨æˆ·åº”è¯¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ StompManager å®ä¾‹ã€‚
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ”¹ StompSubInfo</h3>
                    <div class="description">
                        è®¢é˜…ä¿¡æ¯ï¼ŒåŒ…å« destinationï¼ˆé¢‘é“åœ°å€ï¼‰ã€identifierï¼ˆè®¢é˜…æ ‡è¯†ï¼‰å’Œ headersï¼ˆé¢å¤–çš„è®¢é˜…å¤´ï¼‰ã€‚
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ”¹ StompCallbackLifeHolder</h3>
                    <div class="description">
                        ç”Ÿå‘½å‘¨æœŸæŒæœ‰è€…ï¼Œç”¨äºç®¡ç†è®¢é˜…å›è°ƒçš„ç”Ÿå‘½å‘¨æœŸã€‚å½“å®ƒè¢«é‡Šæ”¾æ—¶ï¼Œç›¸åº”çš„è®¢é˜…ä¼šè¢«è‡ªåŠ¨å–æ¶ˆã€‚
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ”¹ ReceiveMessageStrategy</h3>
                    <div class="description">
                        æ¶ˆæ¯æ¥æ”¶ç­–ç•¥ï¼Œæ§åˆ¶å¦‚ä½•å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚
                    </div>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>æ¶ˆæ¯æ¥æ”¶ç­–ç•¥</span></div>
                        <pre><code class="language-swift">public enum ReceiveMessageStrategy {
    case all                         // æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯
    case throttle(TimeInterval)      // èŠ‚æµï¼šåœ¨æŒ‡å®šæ—¶é—´é—´éš”å†…åªå¤„ç†æœ€åä¸€æ¡æ¶ˆæ¯
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">ä½¿ç”¨ç¤ºä¾‹</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">ğŸ“ åŸºç¡€ä½¿ç”¨</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>åˆ›å»º StompManager å¹¶è®¢é˜…é¢‘é“</span></div>
                        <pre><code class="language-swift">import RYKit

// 1. å®šä¹‰ä½ çš„æ¶ˆæ¯æ¨¡å‹
struct ChatMessage: Codable {
    let id: String
    let content: String
    let sender: String
    let timestamp: Date
}

// 2. å®šä¹‰è‡ªå®šä¹‰çš„ Channel ç±»å‹
class MyStompChannel: StompChannel {
    let userToken: String
    
    init(userToken: String) {
        self.userToken = userToken
    }
    
    func configure() -> StompChannelConfig {
        return StompChannelConfig(
            url: "ws://your-server.com/websocket",
            headers: [
                "Authorization": "Bearer \(userToken)"
            ]
        )
    }
}

// 3. åˆ›å»º StompManager
let manager = StompManager<MyStompChannel>(userToken: "user_token_123")

// 4. è®¢é˜…é¢‘é“
let subscription = StompSubInfo(
    destination: "/topic/chat/room1",
    identifier: "chat_room1_subscriber",
    headers: nil
)

let holder = manager.subscribe(
    dataType: ChatMessage.self,
    subscription: subscription,
    receiveMessageStrategy: .all,
    callbackQueue: .main
) { message, headers, raw in
    if let message = message {
        print("æ”¶åˆ°æ¶ˆæ¯ï¼š\(message.content)")
        print("å‘é€è€…ï¼š\(message.sender)")
    }
}

// holder æŒæœ‰è®¢é˜…ï¼Œé‡Šæ”¾åä¼šè‡ªåŠ¨å–æ¶ˆè®¢é˜…
// ä¿æŒ holder çš„å¼•ç”¨ä»¥ç»´æŒè®¢é˜…</code></pre>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ“ è®¢é˜…å¤šä¸ªé¢‘é“</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>åŒæ—¶è®¢é˜…å¤šä¸ªé¢‘é“</span></div>
                        <pre><code class="language-swift">class ChatViewController: UIViewController {
    let manager = StompManager<MyStompChannel>(userToken: "user123")
    var subscriptionHolders: [StompCallbackLifeHolder?] = []
    
    func subscribeToChannels() {
        // è®¢é˜…èŠå¤©æ¶ˆæ¯
        let chatHolder = manager.subscribe(
            dataType: ChatMessage.self,
            subscription: StompSubInfo(
                destination: "/topic/chat",
                identifier: "chat",
                headers: nil
            ),
            receiveMessageStrategy: .all,
            callbackQueue: .main
        ) { [weak self] message, headers, raw in
            self?.handleChatMessage(message)
        }
        
        // è®¢é˜…é€šçŸ¥æ¶ˆæ¯
        let notificationHolder = manager.subscribe(
            dataType: Notification.self,
            subscription: StompSubInfo(
                destination: "/user/queue/notifications",
                identifier: "notifications",
                headers: nil
            ),
            receiveMessageStrategy: .all,
            callbackQueue: .main
        ) { [weak self] notification, headers, raw in
            self?.handleNotification(notification)
        }
        
        // è®¢é˜…åœ¨çº¿çŠ¶æ€
        let statusHolder = manager.subscribe(
            dataType: UserStatus.self,
            subscription: StompSubInfo(
                destination: "/topic/status",
                identifier: "status",
                headers: nil
            ),
            receiveMessageStrategy: .throttle(1.0),  // 1ç§’å†…åªå¤„ç†æœ€åä¸€æ¡
            callbackQueue: .main
        ) { [weak self] status, headers, raw in
            self?.updateUserStatus(status)
        }
        
        // ä¿å­˜ holders
        subscriptionHolders = [chatHolder, notificationHolder, statusHolder]
    }
    
    func handleChatMessage(_ message: ChatMessage?) {
        guard let message = message else { return }
        // å¤„ç†èŠå¤©æ¶ˆæ¯
    }
    
    func handleNotification(_ notification: Notification?) {
        // å¤„ç†é€šçŸ¥
    }
    
    func updateUserStatus(_ status: UserStatus?) {
        // æ›´æ–°ç”¨æˆ·çŠ¶æ€
    }
    
    deinit {
        // é‡Šæ”¾æ—¶è‡ªåŠ¨å–æ¶ˆæ‰€æœ‰è®¢é˜…
        subscriptionHolders.removeAll()
    }
}</code></pre>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ“ æ¶ˆæ¯èŠ‚æµ</h3>
                    <div class="description">
                        åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆå¦‚è‚¡ç¥¨è¡Œæƒ…ã€å®æ—¶ä½ç½®ï¼‰ï¼Œæ¶ˆæ¯å¯èƒ½éå¸¸é¢‘ç¹ã€‚ä½¿ç”¨èŠ‚æµç­–ç•¥å¯ä»¥é¿å…è¿‡åº¦åˆ·æ–°ç•Œé¢ã€‚
                    </div>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>è‚¡ç¥¨è¡Œæƒ…è®¢é˜… - ä½¿ç”¨èŠ‚æµ</span></div>
                        <pre><code class="language-swift">struct StockPrice: Codable {
    let symbol: String
    let price: Decimal
    let change: Decimal
    let timestamp: Date
}

class StockViewController: UIViewController {
    let manager = StompManager<MyStompChannel>(userToken: "user123")
    var stockHolder: StompCallbackLifeHolder?
    
    func subscribeToStock(symbol: String) {
        stockHolder = manager.subscribe(
            dataType: StockPrice.self,
            subscription: StompSubInfo(
                destination: "/topic/stock/\(symbol)",
                identifier: "stock_\(symbol)",
                headers: nil
            ),
            // ä½¿ç”¨èŠ‚æµï¼š500ms å†…åªå¤„ç†æœ€åä¸€æ¡æ¶ˆæ¯
            // é¿å…è¿‡äºé¢‘ç¹çš„ UI æ›´æ–°
            receiveMessageStrategy: .throttle(0.5),
            callbackQueue: .main
        ) { [weak self] price, headers, raw in
            guard let price = price else { return }
            self?.updateStockPrice(price)
        }
    }
    
    func updateStockPrice(_ price: StockPrice) {
        // æ›´æ–° UI
        priceLabel.text = "\(price.price)"
        changeLabel.text = "\(price.change)"
    }
}</code></pre>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ“ ç›‘å¬è¿æ¥çŠ¶æ€</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–</span></div>
                        <pre><code class="language-swift">import Combine

class ConnectionManager {
    let manager = StompManager<MyStompChannel>(userToken: "user123")
    var cancellables = Set<AnyCancellable>()
    
    func monitorConnection() {
        // ç›‘å¬è¿æ¥çŠ¶æ€
        manager.connectedSubject
            .receive(on: DispatchQueue.main)
            .sink { isConnected in
                if isConnected {
                    print("âœ… WebSocket å·²è¿æ¥")
                    self.showConnectedStatus()
                } else {
                    print("âŒ WebSocket å·²æ–­å¼€")
                    self.showDisconnectedStatus()
                }
            }
            .store(in: &cancellables)
        
        // ä¸»åŠ¨æ£€æŸ¥è¿æ¥çŠ¶æ€
        if manager.connected {
            print("å½“å‰å·²è¿æ¥")
        }
        
        // æ‰‹åŠ¨å¯åŠ¨è¿æ¥
        manager.startConnection()
    }
    
    func showConnectedStatus() {
        // æ˜¾ç¤ºå·²è¿æ¥çŠ¶æ€
    }
    
    func showDisconnectedStatus() {
        // æ˜¾ç¤ºæ–­å¼€è¿æ¥çŠ¶æ€
    }
}</code></pre>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ“ å…¨å±€æ¶ˆæ¯ç›‘å¬</h3>
                    <div class="description">
                        é™¤äº†é’ˆå¯¹ç‰¹å®šè®¢é˜…çš„å›è°ƒï¼Œè¿˜å¯ä»¥ç›‘å¬æ‰€æœ‰è§£ç åçš„æ¶ˆæ¯ã€‚
                    </div>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>å…¨å±€æ¶ˆæ¯ç›‘å¬</span></div>
                        <pre><code class="language-swift">import Combine

class GlobalMessageHandler {
    let manager = StompManager<MyStompChannel>(userToken: "user123")
    var cancellables = Set<AnyCancellable>()
    
    func setupGlobalListeners() {
        // ç›‘å¬æ‰€æœ‰è§£ç æˆåŠŸçš„æ¶ˆæ¯
        manager.decodedPublishedSubject
            .receive(on: DispatchQueue.main)
            .sink { decoded, publisher in
                print("æ”¶åˆ°æ¶ˆæ¯ï¼š\(decoded)")
                print("æ¥è‡ªé¢‘é“ï¼š\(publisher.destination)")
                
                // æ ¹æ®æ¶ˆæ¯ç±»å‹å¤„ç†
                if let chatMsg = decoded as? ChatMessage {
                    self.handleChatMessage(chatMsg)
                } else if let notification = decoded as? NotificationMessage {
                    self.handleNotification(notification)
                }
            }
            .store(in: &cancellables)
        
        // ç›‘å¬æœªè§£ç çš„åŸå§‹æ¶ˆæ¯ï¼ˆç”¨äºè°ƒè¯•æˆ–ç‰¹æ®Šå¤„ç†ï¼‰
        manager.unDecodedPublishedSubject
            .receive(on: DispatchQueue.main)
            .sink { stringMessage, dataMessage, publisher in
                if let message = stringMessage {
                    print("åŸå§‹å­—ç¬¦ä¸²æ¶ˆæ¯ï¼š\(message)")
                }
            }
            .store(in: &cancellables)
    }
    
    func handleChatMessage(_ message: ChatMessage) {
        // å¤„ç†èŠå¤©æ¶ˆæ¯
    }
    
    func handleNotification(_ notification: NotificationMessage) {
        // å¤„ç†é€šçŸ¥
    }
}</code></pre>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ“ å–æ¶ˆè®¢é˜…</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>æ‰‹åŠ¨å–æ¶ˆè®¢é˜…</span></div>
                        <pre><code class="language-swift">// æ–¹å¼1ï¼šé‡Šæ”¾ holderï¼ˆæ¨èï¼‰
var holder: StompCallbackLifeHolder? = manager.subscribe(...)
// å–æ¶ˆè®¢é˜…
holder = nil

// æ–¹å¼2ï¼šè°ƒç”¨ unsubscribe æ–¹æ³•
let subscription = StompSubInfo(
    destination: "/topic/chat",
    identifier: "chat",
    headers: nil
)
manager.unsbscribe(subscription: subscription)

// æ³¨æ„ï¼šå¦‚æœæœ‰å¤šä¸ªå›è°ƒè®¢é˜…åŒä¸€ä¸ª destinationï¼Œ
// åªæœ‰å½“æ‰€æœ‰å›è°ƒéƒ½å–æ¶ˆåï¼Œæ‰ä¼šçœŸæ­£å–æ¶ˆæœåŠ¡å™¨ç«¯çš„è®¢é˜…</code></pre>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ“ å¤„ç†è®¢é˜…å›è°ƒ</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>è®¢é˜…æˆåŠŸ/å¤±è´¥å›è°ƒ</span></div>
                        <pre><code class="language-swift">let holder = manager.subscribe(
    dataType: ChatMessage.self,
    subscription: StompSubInfo(
        destination: "/topic/chat",
        identifier: "chat",
        headers: nil
    ),
    receiveMessageStrategy: .all,
    callbackQueue: .main,
    subscribedCallback: { result in
        switch result {
        case .success(let headerId):
            print("âœ… è®¢é˜…æˆåŠŸï¼Œheader ID: \(headerId)")
            // æ˜¾ç¤ºè®¢é˜…æˆåŠŸçŠ¶æ€
            
        case .failed(let headerId, let error):
            print("âŒ è®¢é˜…å¤±è´¥: \(error)")
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            // æ³¨æ„ï¼šå³ä½¿è®¢é˜…å¤±è´¥ï¼Œä¹Ÿä¼šè‡ªåŠ¨é‡è¯•
        }
    }
) { message, headers, raw in
    // å¤„ç†æ¶ˆæ¯
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">é«˜çº§åŠŸèƒ½</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">ğŸ”’ è‡ªå®šä¹‰ Channel é…ç½®</h3>
                    <div class="description">
                        é€šè¿‡è‡ªå®šä¹‰ StompChannel å®ç°æ¥é…ç½®è¿æ¥å‚æ•°ã€‚
                    </div>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>å®Œæ•´çš„ Channel å®ç°</span></div>
                        <pre><code class="language-swift">import Foundation

class MyStompChannel: StompChannel {
    let userToken: String
    var customHeaders: [String: String] = [:]
    
    init(userToken: String) {
        self.userToken = userToken
    }
    
    func configure() -> StompChannelConfig {
        // è·å–æœ€æ–°çš„è®¤è¯ä¿¡æ¯
        let authToken = AuthManager.shared.getToken() ?? userToken
        
        return StompChannelConfig(
            url: AppConfig.websocketURL,
            headers: [
                "Authorization": "Bearer \(authToken)",
                "Client-Version": AppConfig.version,
                "Device-ID": DeviceInfo.deviceId,
                "User-Agent": "iOS/\(UIDevice.current.systemVersion)"
            ].merging(customHeaders) { $1 },
            heartbeat: (send: 10000, receive: 10000),  // å¿ƒè·³é…ç½®
            timeout: 30  // è¿æ¥è¶…æ—¶
        )
    }
    
    // åŠ¨æ€æ›´æ–° headers
    func updateHeaders(_ headers: [String: String]) {
        customHeaders.merge(headers) { $1 }
    }
}</code></pre>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">âš¡ï¸ æ€§èƒ½ä¼˜åŒ–</h3>
                    <div class="highlight-box">
                        <div class="highlight-box-title">ğŸ’¡ ä¼˜åŒ–å»ºè®®</div>
                        <ul class="feature-list" style="margin: 10px 0;">
                            <li>å¯¹äºé«˜é¢‘æ¶ˆæ¯ä½¿ç”¨ <code>.throttle</code> ç­–ç•¥</li>
                            <li>åœ¨åˆé€‚çš„é˜Ÿåˆ—å¤„ç†æ¶ˆæ¯ï¼ˆUI æ›´æ–°ç”¨ main queueï¼Œå…¶ä»–ç”¨åå°é˜Ÿåˆ—ï¼‰</li>
                            <li>åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„è®¢é˜…</li>
                            <li>åŒä¸€ä¸ª destination çš„å¤šä¸ªè®¢é˜…ä¼šå…±äº«è¿æ¥</li>
                            <li>ä½¿ç”¨ <code>enableLog</code> åœ¨è°ƒè¯•æ—¶æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</li>
                        </ul>
                    </div>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Swift</span><span>æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹</span></div>
                        <pre><code class="language-swift">let manager = StompManager<MyStompChannel>(userToken: "user123")

// å¼€å¯æ—¥å¿—ï¼ˆä»…è°ƒè¯•æ—¶ï¼‰
#if DEBUG
manager.enableLog = true
#endif

// å¯¹äºéœ€è¦è€—æ—¶å¤„ç†çš„æ¶ˆæ¯ï¼Œä½¿ç”¨åå°é˜Ÿåˆ—
let backgroundQueue = DispatchQueue(label: "com.app.stomp.processing", qos: .userInitiated)

manager.subscribe(
    dataType: LargeDataMessage.self,
    subscription: subscription,
    receiveMessageStrategy: .throttle(1.0),
    callbackQueue: backgroundQueue,  // åœ¨åå°é˜Ÿåˆ—å¤„ç†
    subscribedCallback: nil
) { message, headers, raw in
    // è€—æ—¶å¤„ç†
    let processedData = self.processLargeData(message)
    
    // æ›´æ–° UI åˆ‡æ¢åˆ°ä¸»é˜Ÿåˆ—
    DispatchQueue.main.async {
        self.updateUI(with: processedData)
    }
}</code></pre>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ğŸ”„ å¤„ç†é‡è¿</h3>
                    <div class="description">
                        STOMP æ¨¡å—å†…ç½®äº†å¼ºå¤§çš„è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†ã€‚
                    </div>
                    <div class="highlight-box">
                        <div class="highlight-box-title">ğŸ¯ è‡ªåŠ¨é‡è¿ç‰¹æ€§</div>
                        <ul class="feature-list" style="margin: 10px 0;">
                            <li>ç½‘ç»œæ–­å¼€åè‡ªåŠ¨é‡è¿</li>
                            <li>é‡è¿æˆåŠŸåè‡ªåŠ¨æ¢å¤æ‰€æœ‰è®¢é˜…</li>
                            <li>æ™ºèƒ½é‡è¿é—´éš”ï¼ˆ5ç§’èµ·ï¼Œé€æ­¥å¢åŠ åˆ°15ç§’ï¼‰</li>
                            <li>è®¢é˜…å¤±è´¥è‡ªåŠ¨é‡è¯•</li>
                            <li>çº¿ç¨‹å®‰å…¨çš„é‡è¿å¤„ç†</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">API å‚è€ƒ</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">StompManager ä¸»è¦æ–¹æ³•</h3>
                    <table class="api-table">
                        <thead>
                            <tr>
                                <th style="width: 50%;">æ–¹æ³•</th>
                                <th>è¯´æ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>init(userToken:)</code></td>
                                <td>åˆ›å»º StompManager å®ä¾‹</td>
                            </tr>
                            <tr>
                                <td><code>subscribe(...)</code></td>
                                <td>è®¢é˜…é¢‘é“å¹¶æ¥æ”¶æ¶ˆæ¯</td>
                            </tr>
                            <tr>
                                <td><code>unsbscribe(subscription:)</code></td>
                                <td>å–æ¶ˆæŒ‡å®šè®¢é˜…</td>
                            </tr>
                            <tr>
                                <td><code>startConnection(delay:)</code></td>
                                <td>æ‰‹åŠ¨å¯åŠ¨è¿æ¥</td>
                            </tr>
                            <tr>
                                <td><code>connected</code></td>
                                <td>å½“å‰è¿æ¥çŠ¶æ€ï¼ˆBoolï¼‰</td>
                            </tr>
                            <tr>
                                <td><code>connectedSubject</code></td>
                                <td>è¿æ¥çŠ¶æ€ Publisher</td>
                            </tr>
                            <tr>
                                <td><code>decodedPublishedSubject</code></td>
                                <td>å…¨å±€è§£ç æ¶ˆæ¯ Publisher</td>
                            </tr>
                            <tr>
                                <td><code>unDecodedPublishedSubject</code></td>
                                <td>å…¨å±€æœªè§£ç æ¶ˆæ¯ Publisher</td>
                            </tr>
                            <tr>
                                <td><code>enableLog</code></td>
                                <td>æ˜¯å¦å¯ç”¨æ—¥å¿—</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">StompSubInfo å±æ€§</h3>
                    <table class="api-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">å±æ€§</th>
                                <th>è¯´æ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>destination</code></td>
                                <td>è®¢é˜…çš„é¢‘é“åœ°å€ï¼Œå¦‚ "/topic/chat"</td>
                            </tr>
                            <tr>
                                <td><code>identifier</code></td>
                                <td>è®¢é˜…çš„å”¯ä¸€æ ‡è¯†ç¬¦</td>
                            </tr>
                            <tr>
                                <td><code>headers</code></td>
                                <td>é¢å¤–çš„è®¢é˜…å¤´ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æœ€ä½³å®è·µ</h2>
                
                <div class="highlight-box">
                    <div class="highlight-box-title">ğŸ’¡ æ¨èåšæ³•</div>
                    <ul class="feature-list" style="margin: 10px 0;">
                        <li>æ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ª StompManager å®ä¾‹</li>
                        <li>ä½¿ç”¨ weak self é¿å…å¾ªç¯å¼•ç”¨</li>
                        <li>åˆ©ç”¨ StompCallbackLifeHolder è‡ªåŠ¨ç®¡ç†è®¢é˜…ç”Ÿå‘½å‘¨æœŸ</li>
                        <li>å¯¹é«˜é¢‘æ¶ˆæ¯ä½¿ç”¨èŠ‚æµç­–ç•¥</li>
                        <li>åœ¨åˆé€‚çš„é˜Ÿåˆ—å¤„ç†æ¶ˆæ¯ï¼ˆUI æ“ä½œåœ¨ä¸»é˜Ÿåˆ—ï¼‰</li>
                        <li>ä½¿ç”¨ Combine ç›‘å¬è¿æ¥çŠ¶æ€å’Œå…¨å±€æ¶ˆæ¯</li>
                        <li>åœ¨ ViewController/View çš„ deinit ä¸­æ¸…ç†è®¢é˜…</li>
                        <li>å®šä¹‰æ¸…æ™°çš„æ¶ˆæ¯æ¨¡å‹ï¼Œéµå¾ª Codable åè®®</li>
                    </ul>
                </div>

                <div class="code-block">
                    <div class="code-header"><span class="code-lang">Swift</span><span>æ¨èçš„ä½¿ç”¨æ¨¡å¼</span></div>
                    <pre><code class="language-swift">class ChatViewModel: ObservableObject {
    private let stompManager: StompManager<MyStompChannel>
    private var messageHolder: StompCallbackLifeHolder?
    private var cancellables = Set<AnyCancellable>()
    
    @Published var messages: [ChatMessage] = []
    @Published var isConnected = false
    
    init(userToken: String) {
        self.stompManager = StompManager<MyStompChannel>(userToken: userToken)
        setupConnection()
        subscribeToMessages()
    }
    
    private func setupConnection() {
        // ç›‘å¬è¿æ¥çŠ¶æ€
        stompManager.connectedSubject
            .receive(on: DispatchQueue.main)
            .assign(to: &$isConnected)
        
        // å¯åŠ¨è¿æ¥
        stompManager.startConnection()
    }
    
    private func subscribeToMessages() {
        messageHolder = stompManager.subscribe(
            dataType: ChatMessage.self,
            subscription: StompSubInfo(
                destination: "/topic/chat/\(roomId)",
                identifier: "chat_\(roomId)",
                headers: nil
            ),
            receiveMessageStrategy: .all,
            callbackQueue: .main
        ) { [weak self] message, headers, raw in
            guard let self = self, let message = message else { return }
            self.messages.append(message)
        }
    }
    
    deinit {
        // è‡ªåŠ¨æ¸…ç†ï¼šholder é‡Šæ”¾æ—¶ä¼šå–æ¶ˆè®¢é˜…
        messageHolder = nil
    }
}</code></pre>
                </div>
            </div>
        </div>
    </div>

    <script>hljs.highlightAll();</script>
</body>
</html>
